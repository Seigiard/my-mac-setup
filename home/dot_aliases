# ===========================================
# Cross-Platform Aliases (macOS + Linux)
# ===========================================

# Helpers (if not already defined in .zshrc)
has() { command -v "$1" > /dev/null 2>&1; }

# Detect OS
case "$(uname -s)" in
  Darwin) OS="macos" ;;
  Linux)  OS="linux" ;;
esac

# -------------------------------------------
# Modern tool replacements (shadow built-ins)
# -------------------------------------------

has bat && alias cat='bat'
has eza && {
  alias l='eza --group-directories-first'
  alias ls='eza --group-directories-first'
  alias ll='eza -la --group-directories-first'
  alias la='eza -a --group-directories-first'
  alias lt='eza -la --sort=modified --group-directories-first'
}
has btop && { alias h='btop'; alias htop='btop'; }
has dust && alias du='dust'
has duf && alias df='duf'
has procs && alias ps='procs'

# -------------------------------------------
# Navigation
# -------------------------------------------

alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias zi='zoxide query -i'

# -------------------------------------------
# Grep (with colors)
# -------------------------------------------

alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# -------------------------------------------
# Network (OS-specific)
# -------------------------------------------

if [[ "$OS" == "macos" ]]; then
  alias ports='lsof -iTCP -sTCP:LISTEN -n -P'
  alias localip='ipconfig getifaddr en0'
else
  alias ports='ss -tulpn'
  alias localip='hostname -I | awk "{print \$1}"'
  alias free='free -h'
fi
alias myip='curl -s ifconfig.me'

# Kill process by port: killport 6006
killport() {
  local port="$1"
  [[ -z "$port" ]] && { echo "Usage: killport <port>"; return 1; }
  local pid=$(lsof -ti:"$port" 2>/dev/null)
  [[ -z "$pid" ]] && { echo "No process on port $port"; return 0; }
  kill -9 $pid && echo "Killed process(es) on port $port: $pid"
}

# -------------------------------------------
# macOS only
# -------------------------------------------

if [[ "$OS" == "macos" ]]; then
  alias o='open .'
  alias ql='qlmanage -p'
  alias flushdns='sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder'

  # SMB mounts (home.local) - uses Finder for native credential handling
  alias mnt-public='open "smb://guest@home.local/public"'
  alias mnt-andrew='open "smb://andrew@home.local/andrew"'
  alias unmnt-public='diskutil unmount /Volumes/public'
  alias unmnt-andrew='diskutil unmount /Volumes/andrew'
fi

# -------------------------------------------
# Git
# -------------------------------------------

alias g='git'
alias gs='git status'
alias ga='git add'
alias gaa='git add -A'
alias gc='git commit -m'
alias gp='git push'
alias gpl='git pull'
alias gl='git log --oneline -10'
alias gd='git diff'
alias gco='git checkout'
alias gb='git branch'
alias lg='lazygit'

# -------------------------------------------
# Editors
# -------------------------------------------

alias e='micro'
alias m='mc'

# -------------------------------------------
# Safety
# (skip in Claude Code - breaks non-interactive shell)
# -------------------------------------------

if [[ -z "$CLAUDECODE" ]]; then
  alias rm='rm -i'
  alias cp='cp -i'
  alias mv='mv -i'
fi

# -------------------------------------------
# Homelab specific
# -------------------------------------------

alias hldeploy='/opt/homelab/scripts/docker/deploy.sh'
alias hlstop='/opt/homelab/scripts/docker/stop.sh'
alias hlrebuild='/opt/homelab/scripts/docker/rebuild.sh'
alias hlstatus='/opt/homelab/scripts/docker/status.sh'
alias hllogs='cd /opt/homelab && docker compose logs -f'

# -------------------------------------------
# Misc
# -------------------------------------------

alias reload='source ~/.zshrc'
alias path='echo -e ${PATH//:/\\n}'
alias now='date +"%Y-%m-%d %H:%M:%S"'
alias week='date +%V'
alias zsh-bench='for i in {1..5}; do time zsh -i -c exit; done'

# Alert for long-running commands (Linux only)
if [[ "$OS" == "linux" ]]; then
  alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'
fi

# -------------------------------------------
# Yazi - cd to directory on exit
# -------------------------------------------

function y() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
  yazi "$@" --cwd-file="$tmp"
  if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd -- "$cwd"
  fi
  rm -f -- "$tmp"
}
