#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Install packages via Homebrew (cross-platform)
# This script runs when the hash of packages list changes

set -e

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add brew to PATH for this session
    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /home/linuxbrew/.linuxbrew/bin/brew ]]; then
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    fi
fi

echo "Installing packages via Homebrew..."

# ===========================================
# Cross-platform CLI tools
# ===========================================

# Shell & prompt
brew install zsh
brew install starship

# Git tools
brew install git
brew install gh
brew install delta
brew install lazygit

# Version manager
brew install mise

# Search & text processing
brew install ripgrep
brew install ast-grep
brew install bat
brew install jq
brew install rq
brew install tldr

# File management
brew install yazi
brew install fd
brew install fzf
brew install zoxide
brew install eza
brew install ouch

# System monitoring
brew install btop
brew install procs
brew install dust
brew install duf

# Yazi dependencies
brew install ffmpeg
brew install sevenzip
brew install poppler
brew install resvg
brew install imagemagick

# # {{ if eq .chezmoi.os "darwin" }}
# ===========================================
# macOS-specific packages
# ===========================================

# Taps
brew tap lazywalker/rgrc
brew tap yqrashawn/goku

# CLI tools (macOS only)
brew install rgrc
brew install terminal-notifier

# Fonts
brew install --cask font-symbols-only-nerd-font
brew install --cask font-recursive-code
brew install --cask font-jetbrains-mono

# GUI Applications
brew install --cask ghostty
brew install --cask marta
brew install --cask raycast
brew install --cask karabiner-elements
brew install yqrashawn/goku/goku
brew install --cask zed
brew install --cask obsidian
brew install --cask webstorm
brew install --cask vscodium
brew install --cask figma
brew install --cask the-unarchiver
brew install --cask imageoptim
brew install --cask setapp
brew install --cask dropbox
brew install --cask ticktick
brew install --cask transmission
brew install --cask spotify
brew install --cask notunes
brew install --cask iina
brew install --cask brave-browser
brew install --cask floorp
brew install --cask telegram
brew install --cask android-file-transfer

# # {{ end }}

echo "Package installation complete!"

# Install Oh My Zsh if not present
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    echo "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Install Oh My Zsh plugins
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [[ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
fi
if [[ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]]; then
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
fi
if [[ ! -d "$ZSH_CUSTOM/plugins/zsh-history-substring-search" ]]; then
    git clone https://github.com/zsh-users/zsh-history-substring-search "$ZSH_CUSTOM/plugins/zsh-history-substring-search"
fi

# Initialize mise
if command -v mise &> /dev/null; then
    mise use --global node@lts
fi

# # {{ if eq .chezmoi.os "darwin" }}
# Install Yazi plugins (macOS)
if command -v ya &> /dev/null; then
    ya pkg add yazi-rs/plugins:piper || true
    ya pkg add ndtoan96/ouch || true
fi

# Run goku to compile karabiner config
if command -v goku &> /dev/null; then
    goku || true
fi
# # {{ end }}

echo "Setup complete!"
